#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Step 1: Run the build process
echo "Running build process..."
pnpm run build
if [ $? -ne 0 ]; then
  echo "Build failed. Aborting push."
  exit 1
fi

# Step 2: Create the database migration
echo "Creating a new database migration..."
pnpm run payload:migrate:create > migration_output.log
if [ $? -ne 0 ]; then
  echo "Migration creation failed. Aborting push."
  exit 1
fi

# Check if a migration file was created by inspecting the output
if grep -q "No schema changes detected" migration_output.log; then
  echo "No new migration detected. Skipping commit and push."
  rm migration_output.log
  exit 0
fi

rm migration_output.log

# Step 3: Add the migration files to VCS
echo "Adding migration files to version control..."
git add src/migrations/
if [ $? -ne 0 ]; then
  echo "Failed to stage migration files. Aborting push."
  exit 1
fi

# Step 4: Commit the migration
echo "Committing migration files..."
git commit -m "chore: add migration for latest build"
if [ $? -ne 0 ]; then
  echo "Failed to commit migration files. Aborting push."
  exit 1
fi

# Step 5: Push the changes
echo "Pushing changes..."
git push
if [ $? -ne 0 ]; then
  echo "Push failed. Aborting."
  exit 1
fi